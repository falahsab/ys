<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ²Ø¹</title>

<style>
body {
  font-family: "Tajawal", sans-serif;
  background: #f1f5f9;
  margin: 0;
  padding: 20px;
  box-sizing: border-box;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

h2 {
  color: #0f172a;
  margin: 5px 0;
}

.logout-btn {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  transition: 0.3s;
}

.logout-btn:hover {
  background: #dc2626;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  box-sizing: border-box;
}

.summary {
  background: #fff;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  box-shadow: 0 4px 10px #0001;
  font-size: 14px;
}

.summary1 {
  background: #e9f5ff;
  padding: 12px;
  border: 1px solid #0d6efd;
  border-radius: 6px;
  margin: 10px 0;
  font-weight: bold;
}

.progress-container {
  background: #e5e7eb;
  border-radius: 10px;
  height: 25px;
  margin-bottom: 15px;
  overflow: hidden;
}

#progressBar1, #progressBar2 {
  height: 100%;
  width: 0%;
  text-align: center;
  color: white;
  line-height: 25px;
  font-weight: bold;
}

#progressBar1 { background: #2563eb; }
#progressBar2 { background: #16a34a; }

.level-profit {
  background: #f8fafc;
  border: 1px dashed #94a3b8;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 15px;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
  flex-direction: column;
}

.filters input, .filters select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  flex: 1;
  min-width: 120px;
}

.filters button {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  background: #2563eb;
  color: white;
  cursor: pointer;
  transition: 0.3s;
}

.filters button:hover { background: #1d4ed8; }

.table-container {
  overflow-x: auto;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 10px #0001;
}

#dataTable {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

#dataTable th, #dataTable td {
  padding: 8px 12px;
  border-bottom: 1px solid #e5e7eb;
  text-align: center;
  white-space: nowrap;
}

#dataTable th {
  background: #2563eb;
  color: white;
}

.status-Refund { color: red; font-weight: bold; }
.status-Completed { color: green; }
.status-Pending { color: orange; }

@media(max-width:600px){
  .filters { flex-direction: column; }
  .summary { font-size: 13px; }
  #dataTable th, #dataTable td { font-size: 12px; padding: 6px; }
}
</style>

</head>

<body>

<div class="header">
  <h2>Ù…Ø±Ø­Ø¨Ø§ØŒ <span id="dealerName"></span></h2>
  <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="summary1">
ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„: 40 Ù…Ø§Ù†Ø¬Ùˆ<br>
ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚: <span id="percent1">0</span> %
</div>
<div class="progress-container"><div id="progressBar1">0%</div></div>

<div class="summary1">
ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ: 70 Ù…Ø§Ù†Ø¬Ùˆ<br>
ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚: <span id="percent2">0</span> %
</div>
<div class="progress-container"><div id="progressBar2">0%</div></div>

<div class="level-profit">
ğŸ’° Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„: <span id="level1Profit">0</span> Ù…Ø§Ù†Ø¬Ùˆ<br>
ğŸ’° Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ: <span id="level2Profit">0</span> Ù…Ø§Ù†Ø¬Ùˆ<br>
ğŸ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª: <span id="levelsTotalProfit">0</span> Ù…Ø§Ù†Ø¬Ùˆ
</div>

<div class="summary">
ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="totalProfit">0</span> Ù…Ø§Ù†Ø¬Ùˆ<br>
ğŸ›’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalAmount">0</span> Ù…Ø§Ù†Ø¬Ùˆ<br>
ğŸ”¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <span id="totalCodes">0</span><br>
âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù„ØºÙŠØ©: <span id="cancelledCodes">0</span><br>
âœ… ØµØ§ÙÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: <span id="netCodes">0</span>
</div>

<div class="filters">
  <input type="date" id="startDate">
  <input type="date" id="endDate">
  <select id="filterUser"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option></select>
  <button onclick="applyFilters()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
  <button onclick="resetFilters()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
</div>

<div class="table-container">
<table id="dataTable">
<thead>
<tr>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
<th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>SN</th><th>Profit</th><th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyxZ2RsVQyQdDC_pzCPIsIzj4MLFZeoFUF1rvyHFxlynEXsa-kJBY6d_eY8gxXaBNoX0Q/exec";
let allData=[],filteredData=[];
let dealer=sessionStorage.getItem("dealer");
/* âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
if(!dealer){
  window.location.href="login.html";
}

async function loadData(){
  dealerName.innerText=dealer;
  const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({dealer})});
  const json=await res.json();
  allData=json.data||[];
  filteredData=[...allData];
  fillUserFilter(allData);
  renderTable(filteredData);
}

const level1ProfitEl = document.getElementById("level1Profit");
const level2ProfitEl = document.getElementById("level2Profit");
const levelsTotalProfitEl = document.getElementById("levelsTotalProfit");

async function loadData(){
  if(!dealer){ alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }
  dealerName.innerText=dealer;

  const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({dealer})});
  const json=await res.json();
  allData=json.data||[];
  filteredData=[...allData];
  fillUserFilter(allData);
  renderTable(filteredData);
}

function fillUserFilter(data){
  filterUser.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>';
  [...new Set(data.map(r=>r[3]))].forEach(u=>{
    if(u){ filterUser.innerHTML+=`<option>${u}</option>` }
  });
}

function applyFilters(){
  filteredData=allData.filter(r=>{
    const d=r[0].split("T")[0];
    return (!startDate.value||d>=startDate.value)
      &&(!endDate.value||d<=endDate.value)
      &&(!filterUser.value||r[3]==filterUser.value);
  });
  renderTable(filteredData);
}

function resetFilters(){
  startDate.value=endDate.value=filterUser.value="";
  renderTable(allData);
}

function renderTable(data){
  let profit=0,amount=0,cancelled=0;
  dataTable.querySelector("tbody").innerHTML="";

  data.forEach(r=>{
    const p=Number(r[5])||0;
    profit+=p;
    amount+=Number(r[2])||0;
    if(p<0) cancelled++;

    dataTable.querySelector("tbody").innerHTML+=`
    <tr>
      <td>${r[0].split("T")[0]}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td class="status-${r[6]}">${r[6]}</td>
    </tr>`;
  });

totalProfit.innerText = Number(profit.toFixed(3));
totalAmount.innerText = Number(amount.toFixed(3));
totalCodes.innerText = data.length;
cancelledCodes.innerText = cancelled;
netCodes.innerText = data.length - (cancelled*2);


  const raw1 = (profit / 40) * 100;
  const raw2 = (profit / 70) * 100;

  percent1.innerText = raw1.toFixed(1);
  percent2.innerText = raw2.toFixed(1);

  progressBar1.style.width = Math.min(raw1,100)+"%";
  progressBar2.style.width = Math.min(raw2,100)+"%";
  progressBar1.innerText = raw1.toFixed(1)+"%";
  progressBar2.innerText = raw2.toFixed(1)+"%";

  const level1Profit = raw1 >= 100 ? profit : 0;
  const level2Profit = raw2 >= 100 ? profit * 0.7 : 0;

  level1ProfitEl.innerText = level1Profit.toLocaleString();
  level2ProfitEl.innerText = level2Profit.toLocaleString();
  levelsTotalProfitEl.innerText = (level1Profit + level2Profit).toLocaleString();
}

function logout() {
  sessionStorage.clear();          // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
  window.location.href = "login.html"; // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
}
window.onload=loadData;
</script>

</body>
</html>
