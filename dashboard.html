<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ²Ø¹</title>

<style>
body { font-family:"Tajawal",sans-serif; background:#f1f5f9; margin:0; padding:20px; box-sizing:border-box; }
.header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:15px; }
h2 { color:#0f172a; margin:5px 0; }
.logout-btn { background:#ef4444; color:white; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; transition:0.3s; }
.logout-btn:hover { background:#dc2626; }

input, select { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:1px solid #d1d5db; font-size:15px; box-sizing:border-box; }

.summary { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 4px 10px #0001; font-size:14px; }

.summary1{
  background:#e9f5ff;
  padding:12px;
  border:1px solid #0d6efd;
  border-radius:6px;
  margin:10px 0;
  font-weight:bold;
}

.progress-container { background:#e5e7eb; border-radius:10px; height:25px; margin-bottom:15px; overflow:hidden; }

#progressBar1, #progressBar2 {
  height:100%;
  width:0%;
  text-align:center;
  color:white;
  line-height:25px;
  font-weight:bold;
}

#progressBar1 { background:#2563eb; }
#progressBar2 { background:#16a34a; }

.filters { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; flex-direction: column }
.filters button { padding:10px 20px; border-radius:8px; border:none; background:#2563eb; color:white; cursor:pointer; transition:0.3s; }
.filters button:hover { background:#1d4ed8; }

.table-container { overflow-x:auto; background:#fff; border-radius:12px; box-shadow:0 4px 10px #0001; }
#dataTable { width:100%; border-collapse:collapse; min-width:600px; }
#dataTable th, #dataTable td { padding:8px 12px; border-bottom:1px solid #e5e7eb; text-align:center; white-space:nowrap; }
#dataTable th { background:#2563eb; color:white; }

.status-Refund { color:red; font-weight:bold; }
.status-Completed { color:green; }
.status-Pending { color:orange; }

@media(max-width:600px){
  .summary { font-size:13px; }
  #dataTable th,#dataTable td{ font-size:12px; padding:6px; }
}
</style>
</head>

<body>

<div class="header">
  <h2>Ù…Ø±Ø­Ø¨Ø§ØŒ <span id="dealerName"></span></h2>
  <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ -->
<div class="summary1">
ğŸ¯ Ø§Ù„Ù‡Ø¯Ù (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„): <span>200</span> Ø±ÙŠØ§Ù„<br>
ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚: <span id="percent1">0</span> %
</div>
<div class="progress-container">
  <div id="progressBar1">0%</div>
</div>

<!-- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
<div class="summary1">
ğŸ¯ Ø§Ù„Ù‡Ø¯Ù (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ): <span>100</span> Ø±ÙŠØ§Ù„<br>
ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚: <span id="percent2">0</span> %
</div>
<div class="progress-container">
  <div id="progressBar2">0%</div>
</div>

<div class="summary">
ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="totalProfit">0</span> Ø±ÙŠØ§Ù„<br>
ğŸ›’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalAmount">0</span> Ø±ÙŠØ§Ù„<br>
ğŸ”¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <span id="totalCodes">0</span><br>
âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù„ØºÙŠØ©: <span id="cancelledCodes">0</span><br>
âœ… ØµØ§ÙÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: <span id="netCodes">0</span>
</div>

<div class="filters">
  <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
  <input type="date" id="startDate">
  <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
  <input type="date" id="endDate">
  <select id="filterUser"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option></select>
  <button onclick="applyFilters()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
  <button onclick="resetFilters()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
  <button onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
</div>

<div class="table-container">
<table id="dataTable">
<thead>
<tr>
  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
  <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
  <th>SN</th>
  <th>Profit</th>
  <th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyxZ2RsVQyQdDC_pzCPIsIzj4MLFZeoFUF1rvyHFxlynEXsa-kJBY6d_eY8gxXaBNoX0Q/exec";
let allData=[], filteredData=[];
let dealer=sessionStorage.getItem("dealer");

async function loadData(){
  if(!dealer){ alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); location.href="login.html"; return; }
  document.getElementById("dealerName").innerText=dealer;

  const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({dealer})});
  const data=await res.json();
  allData=data.data||[];
  filteredData=[...allData];
  fillUserFilter(allData);
  renderTable(filteredData);
}

function fillUserFilter(data){
  const select=document.getElementById("filterUser");
  select.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>';
  [...new Set(data.map(r=>r[3]))].forEach(u=>{
    if(u){ let o=document.createElement("option"); o.value=o.text=u; select.appendChild(o); }
  });
}

function applyFilters(){
  const s=startDate.value,e=endDate.value,u=filterUser.value;
  filteredData=allData.filter(r=>{
    const d=r[0].split("T")[0];
    return (!s||d>=s)&&(!e||d<=e)&&(!u||r[3]==u);
  });
  renderTable(filteredData);
}

function resetFilters(){
  startDate.value=endDate.value=filterUser.value="";
  filteredData=[...allData];
  renderTable(filteredData);
}

function renderTable(data){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  let totalProfit=0,totalAmount=0,cancelled=0;

  data.forEach(r=>{
    const profit=Number(r[5])||0;
    totalProfit+=profit;
    totalAmount+=Number(r[2])||0;
    if(profit<0) cancelled++;

    tbody.innerHTML+=`
    <tr>
      <td>${r[0].split("T")[0]}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td class="status-${r[6]}">${r[6]}</td>
    </tr>`;
  });

  totalProfitEl.innerText=totalProfit.toLocaleString();
  totalAmountEl.innerText=totalAmount.toLocaleString();
  totalCodes.innerText=data.length;
  cancelledCodes.innerText=cancelled;
  netCodes.innerText=data.length-(cancelled*2);

  // ===== Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª =====
  const p1=Math.min((totalProfit/200)*100,100).toFixed(1);
  const p2=Math.min((totalProfit/100)*100,100).toFixed(1);

  percent1.innerText=p1;
  percent2.innerText=p2;
  progressBar1.style.width=p1+"%";
  progressBar2.style.width=p2+"%";
  progressBar1.innerText=p1+"%";
  progressBar2.innerText=p2+"%";
}

function exportExcel(){
  XLSX.writeFile(XLSX.utils.table_to_book(dataTable), dealer+"_report.xlsx");
}
function logout(){ sessionStorage.clear(); location.href="login.html"; }

window.onload=loadData;
</script>

</body>
</html>
