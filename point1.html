<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🏆 لوحة نقاط المسابقة</title>

<style>
body { background:#0F172A; color:#fff; font-family:"Tajawal",sans-serif; padding:20px; text-align:center; }
input, button, select { padding:10px; margin:8px; font-size:18px; border-radius:10px; border:none; outline:none; }
input { width:200px; text-align:center; }
button { background:#01C38D; cursor:pointer; transition:.2s; }
button:hover { background:#00A97A; }
.result { background:#1E293B; padding:15px; border-radius:12px; margin-top:20px; font-size:22px; min-height:40px; display:flex; align-items:center; justify-content:center; }
table { width:90%; margin:auto; margin-top:20px; border-collapse:collapse; }
th, td { border:1px solid #fff; padding:5px; font-size:14px; }
th { background:#1E293B; }
.deleteBtn { background:#E11D48; padding:6px 10px; border-radius:6px; font-size:16px; }
.deleteBtn:hover { background:#9F1239; }
</style>
</head>

<body>

<h2>🏆 لوحة نقاط المسابقة</h2>

<input type="number" id="userNumber" placeholder="رقم اللاعب">
<button onclick="getPoints()">عرض النقاط</button>
<br>
<div id="result" class="result"></div>
<br>
<input type="number" id="filterPoints" placeholder="تصفية بالنقاط">
<button onclick="filterByPoints()">🔍 تصفية</button>
<button onclick="refreshRanking()">🔄 عرض الكل</button>
<br>
<h3>🏅 ترتيب اللاعبين</h3>
<table id="ranking">
<thead>
<tr>
  <th>الرقم</th>
  <th>النقاط</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwDKAydttnPT7uahoqkuEnVUfHsSzNf1cTk3kaMtga_ASWqM6UdKS6OfBjBvy3lkU6nfA/exec";

function showMessage(msg, isError = false) {
  const resultEl = document.getElementById("result");
  resultEl.textContent = msg;
  resultEl.style.color = isError ? "#FF4D4D" : "#01C38D";
}

// جلب لاعبين من API
function getPlayers(callback) {
  fetch(`${API_URL}`)
    .then(res => res.json())
    .then(data => {
      if (!data.error) callback(data.players);
    });
}

// إبراز المتصدرين بلون ذهبي وتاج
function highlightLeaders(players) {
  let maxPoints = Math.max(...players.map(p => p.point));
  players.forEach(p => {
    if (p.point === maxPoints) {
      p.isLeader = true;
    }
  });
}

// تحديث جدول الترتيب
function renderTable(players) {
  const tbody = document.querySelector("#ranking tbody");
  tbody.innerHTML = "";

  highlightLeaders(players);

  players.sort((a, b) => b.point - a.point).forEach(p => {
    const row = `<tr style="background:${p.isLeader ? '#D4AF37' : '#1E293B'};">
      <td>${p.isLeader ? "👑 " : ""}${p.number}</td>
      <td>${p.point}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

function refreshRanking() {
  getPlayers(players => renderTable(players));
}

// دالة التصفية حسب النقاط
function filterByPoints() {
  const value = document.getElementById("filterPoints").value.trim();
  if (!value) return alert("اكتب عدد النقاط التي تريد تصفية اللاعبين بناءً عليها");

  getPlayers(players => {
    let filtered = players.filter(p => p.point == value);
    renderTable(filtered);
  });
}

/* وظائف النقاط كما هي */
function getPoints() {
  const userNumber = document.getElementById("userNumber").value.trim();
  if (!userNumber) return alert("ادخل رقم اللاعب");

  fetch(`${API_URL}?number=${encodeURIComponent(userNumber)}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) showMessage("❌ " + data.error, true);
      else showMessage(`✅ رقم اللاعب: ${data.number} | النقاط: ${data.points}`);
      refreshRanking();
    })
    .catch(() => showMessage("⚠️ خطأ باتصال الخادم", true));
}

function addPoints() {
  const userNumber = document.getElementById("userNumber").value.trim();
  const points = document.getElementById("pointsToAdd").value.trim();
  if (!userNumber || !points) return alert("ادخل رقم اللاعب وعدد النقاط");

  fetch(`${API_URL}?number=${encodeURIComponent(userNumber)}&points=${encodeURIComponent(points)}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) showMessage("❌ " + data.error, true);
      else {
        showMessage(`🎯 تم التحديث | النقاط الجديدة: ${data.points}`);
        document.getElementById("pointsToAdd").value = "";
        refreshRanking();
      }
    })
    .catch(() => showMessage("⚠️ خطأ أثناء حفظ البيانات", true));
}

function resetPoints() {
  const userNumber = document.getElementById("userNumber").value.trim();
  if(!userNumber) return alert("ادخل رقم اللاعب");

  fetch(`${API_URL}?number=${encodeURIComponent(userNumber)}&points=0`)
    .then(res => res.json())
    .then(() => {
      showMessage(`♻️ تم تصفير النقاط`);
      refreshRanking();
    });
}

function addPlayer() {
  const newNumber = document.getElementById("newNumber").value.trim();
  const newPoints = document.getElementById("newPoints").value.trim();
  if(!newNumber || !newPoints) return alert("ادخل الرقم والنقاط للاعب الجديد");

  fetch(`${API_URL}?number=${encodeURIComponent(newNumber)}&points=${encodeURIComponent(newPoints)}&add=true`)
    .then(res => res.json())
    .then(data => {
      if(data.error) showMessage("❌ "+data.error,true);
      else {
        showMessage(`➕ تم إضافة اللاعب ${data.number} بالنقاط ${data.points}`);
        document.getElementById("newNumber").value = "";
        document.getElementById("newPoints").value = "";
        refreshRanking();
      }
    });
}

refreshRanking();
</script>

</body>
</html>
