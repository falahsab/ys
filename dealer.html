<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ²Ø¹ - ÙŠÙ…Ù† Ø³ØªÙ„Ø§ÙŠØª</title>

<!-- Ù…ÙƒØªØ¨Ø© XLSX Ù„ØªØµØ¯ÙŠØ± Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
  font-family: Tahoma, Arial;
  background:#f4f6f9;
  margin:0;
  padding:15px;
}
.container{
  max-width:1100px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,.1);
}
h3,h4{margin:10px 0;font-weight:bold;color:#0d6efd;}
input,button,select{
  padding:10px;
  font-size:14px;
  margin:5px 0;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:#0d6efd;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{opacity:.9;}
.summary{
  background:#e9f5ff;
  padding:12px;
  border:1px solid #0d6efd;
  border-radius:6px;
  margin:10px 0;
  font-weight:bold;
}
.filters{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.filters div{flex:1}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:13px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{
  background:#0d6efd;
  color:#fff;
}
.status-Completed{color:green;font-weight:bold}
.status-Pending{color:orange;font-weight:bold}
.status-Canceled{color:red;font-weight:bold}
.status-Refund{color:red;font-weight:bold}

@media(max-width:768px){
  table{font-size:12px;}
  .filters{flex-direction:column;}
}
</style>
</head>

<body>

<div class="container">

<h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ²Ø¹</h3>

<div id="loginBox">
  <input id="mobile" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="dashboard" style="display:none">

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h4 id="welcome"></h4>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>

<div class="summary">
  ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="totalProfit">0</span> Ø±ÙŠØ§Ù„<br>
  ğŸ›’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <span id="totalAmount">0</span> Ø±ÙŠØ§Ù„<br>
  ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: <span id="totalCodes">0</span>
</div>


  <div class="filters">
    <div>
      <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="fromDate">
    </div>
    <div>
      <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="toDate">
    </div>
    <div>
      <label>User</label>
      <select id="userFilter"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    </div>
    <div>
      <label>&nbsp;</label>
      <button onclick="applyFilter()">ÙÙ„ØªØ±Ø©</button>
    </div>
  </div>

  <button onclick="exportExcel()">â¬‡ ØªØ­Ù…ÙŠÙ„ Excel</button>

  <div style="overflow-x:auto">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>User</th>
          <th>SN</th>
          <th>Ø§Ù„Ø±Ø¨Ø­</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz9-PcXjV4RxpN6996rhgyYIScNbo8rDnhROrAh_Lp3b75lnwqX5k_I0nafkIJ8WjgJZQ/exec"; // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App
let allData = [];

function login(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      mobile: mobile.value,
      password: password.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){
      alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      return;
    }

    document.getElementById("loginBox").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("welcome").innerText="Ù…Ø±Ø­Ø¨Ù‹Ø§ " + d.dealer;

    allData = d.data; // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ù† Apps Script
    populateUserFilter(allData);
    renderTable(allData);
  })
  .catch(e=>{
    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: " + e);
  });
}

// Ø²Ø± Ø®Ø±ÙˆØ¬
function logout(){
  document.getElementById("loginBox").style.display="block";
  document.getElementById("dashboard").style.display="none";
  mobile.value = "";
  password.value = "";
  allData = [];
  document.getElementById("userFilter").innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Users Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
function populateUserFilter(data){
  const select = document.getElementById("userFilter");
  let usersSet = new Set();
  data.forEach(r=>{
    if(r[3]) usersSet.add(r[3]);
  });
  usersSet.forEach(u=>{
    let option = document.createElement("option");
    option.value = u;
    option.innerText = u;
    select.appendChild(option);
  });
}

function renderTable(data){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  let totalProfit = 0;
  let totalAmount = 0;
  let totalCodes = data.length; // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ = Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ

  data.forEach(r=>{
    totalProfit += Number(r[5]) || 0; // Ø¹Ù…ÙˆØ¯ Profit
    totalAmount += Number(r[2]) || 0; // Ø¹Ù…ÙˆØ¯ Amount

    let statusClass =
      r[6] === "Refund" ? "status-Refund" :
      r[6] === "Completed" ? "status-Completed" :
      r[6] === "Pending" ? "status-Pending" : "";

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r[0].split("T")[0]}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td class="${statusClass}">${r[6]}</td>
    `;
    tbody.appendChild(tr);
  });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  document.getElementById("totalProfit").innerText = totalProfit.toLocaleString();
  document.getElementById("totalAmount").innerText = totalAmount.toLocaleString();
  document.getElementById("totalCodes").innerText = totalCodes;
}


function applyFilter(){
  let from = fromDate.value ? fromDate.value : null; // YYYY-MM-DD
  let to = toDate.value ? toDate.value : null;
  let user = userFilter.value;

  let filtered = allData.filter(r=>{
    // ØªØ­ÙˆÙŠÙ„ r[0] (Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒØ§Ù…Ù„) Ø¥Ù„Ù‰ YYYY-MM-DD ÙÙ‚Ø·
    let dateStr = r[0].split('T')[0];

    if(from && dateStr < from) return false;
    if(to && dateStr > to) return false;
    if(user && r[3] !== user) return false;
    return true;
  });

  renderTable(filtered);
}


// ØªØµØ¯ÙŠØ± Excel Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function exportExcel1(){
  let table = document.getElementById("dataTable");
  let wb = XLSX.utils.table_to_book(table, {sheet:"Sheet1"});
  XLSX.writeFile(wb, "dealer_report.xlsx");
}

function exportExcel(){
  let table = document.getElementById("dataTable");

  // Ø§Ø³Ù… Ø§Ù„Ø¯ÙŠÙ„Ø± Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
  let dealerName = sessionStorage.getItem("dealer") || "dealer";

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
  dealerName = dealerName.replace(/[\\\/:*?"<>|]/g, "_");

  let wb = XLSX.utils.table_to_book(table, { sheet: "Report" });

  XLSX.writeFile(wb, dealerName + "_report.xlsx");
}
</script>

</body>
</html>
