<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--txt:#e6eef8;--accent:#06b6d4;--success:#10b981;--warn:#f59e0b;--violet:#7c3aed;}
body{margin:0;font-family:sans-serif;background:#000000;
color:#ffffff;}
.container{max-width:900px;margin:10px auto;padding:10px;}
header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
.cards{display:flex;flex-direction:column;gap:10px;}

.badge-received{background:rgba(6,182,212,0.2);color:var(--accent);}
.badge-processing{background:rgba(245,158,11,0.2);color:var(--warn);}
.badge-ready{background:rgba(16,185,129,0.2);color:var(--success);}
.badge-delivered{background:rgba(124,58,237,0.2);color:var(--violet);}
button{cursor:pointer;border:none;border-radius:5px;padding:5px 10px;font-weight:700;}
.small{font-size:14px;}
.danger{background:#2b0b0b;color:#ffb4b4;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;}
.modal-content{background:var(--card);padding:15px;border-radius:10px;width:90%;max-width:350px;display:flex;flex-direction:column;gap:8px;}
.modal-content input{padding:8px;border-radius:5px;border:none;background:rgba(255,255,255,0.05);color:var(--txt);}
.modal-content button{background:var(--accent);color:#012;}
.counter{margin-bottom:10px;font-weight:700;}
.filterBar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.filterBtn{padding:5px 10px;border-radius:5px;background:#ffffff;border:1px solid rgba(255,255,255,0.2);}
.filterBtn.active{background:var(--accent);color:#ffffff;}
@media(max-width:600px){.card{flex-direction:column;align-items:flex-start;}}
.card{
  background:#191919;
  padding:12px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.card-top{
  display:flex;
  justify-content:space-between;
  width:100%;
  align-items:center;
}

.order-title{
  font-size:18px;
  font-weight:900;
  color:#fff;
}

.card-info{
  font-size:14px;
  color:#cfd5df;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.statusBadge{
  padding:4px 10px;
  border-radius:20px;
  font-size:13px;
  font-weight:700;
}

.actions{
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:5px;
}

.action-item{
  display:flex;
  align-items:center;
  gap:4px;
  background:#ffffff;
  padding:5px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  border:none;
}
.action-item:hover{
  opacity:0.8;
}

</style>
</head>
<body>
<div class="container">
<header>
<h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
<div>
<span class="counter" id="processingCounter">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²: 0</span>
<div class="filterBar">
<button class="filterBtn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
<button class="filterBtn" data-filter="ready">Ø¬Ø§Ù‡Ø²</button>
<button class="filterBtn" data-filter="delivered">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
<button id="addOrderBtn">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</button>
</div>
</div>
</header>
<main>
<div id="cards" class="cards"></div>
<div id="empty" style="display:none;color:#9aa6b2;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>
</main>
</div>

<!-- Modal -->
<div class="modal" id="orderModal">
<div class="modal-content">
<h3>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨</h3>
<input type="hidden" id="editRow">
<input type="text" id="newOrderID" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨">
<input type="text" id="newCustomer" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
<input type="text" id="newPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<input type="text" id="newPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
<input type="date" id="newDate">
<button id="saveOrderBtn">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
<button id="closeModalBtn" style="background:#f59e0b;">Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>

<script>
const API_BASE="https://script.google.com/macros/s/AKfycbyrGHgDi-fLdF7-LtNhDtff7bSfLm7dZ-aSTEtUA2RPdVXWHM8QswiTWaFv1Stin3yT/exec"; 
const $ = s=>document.querySelector(s);
let orders=[];

async function fetchOrders(){
  try{
    orders=await (await fetch(API_BASE)).json();
    render();
  }catch(e){console.error(e); alert("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");}
}

function render(){
  const cardsEl=$('#cards'); cardsEl.innerHTML='';
  if(!orders.length){$('#empty').style.display='block'; return;} else $('#empty').style.display='none';
  const processingCount=orders.filter(o=>o.Status==2).length;
  $('#processingCounter').textContent='Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²: '+processingCount;

  const activeFilter=$('.filterBtn.active')?.dataset.filter||'all';
  const filtered=orders.filter(o=>activeFilter==='all'||(activeFilter==='ready'&&o.Status==3)||(activeFilter==='delivered'&&o.Status==4));
  filtered.reverse().forEach(o=>cardsEl.appendChild(createCard(o)));
}

function createCard(o){
  const div=document.createElement('div');
  div.className='card';

  const statusTexts=['ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…','Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²','Ø¬Ø§Ù‡Ø²','ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'];
  const statusClasses=['badge-received','badge-processing','badge-ready','badge-delivered'];
  const badge=document.createElement('span');
  badge.className='statusBadge '+(statusClasses[o.Status-1]||statusClasses[0]);
  badge.textContent=statusTexts[o.Status-1]||statusTexts[0];

  // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„
  const top=document.createElement('div');
  top.className='card-top';
  top.innerHTML=`<div class="order-title">#${o.OrderID} â€” ${o.CustomerName}</div>`;
  top.appendChild(badge);
  div.appendChild(top);

  // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ
  const info=document.createElement('div');
  info.className='card-info';
  let dateFormatted='';
  if(o.Date) {
    const d=new Date(o.Date);
    dateFormatted=(('0'+d.getDate()).slice(-2))+'/'+(('0'+(d.getMonth()+1)).slice(-2))+'/'+String(d.getFullYear()).slice(2);
  }
  info.innerHTML=`
    <span>ğŸ“ ${o.Phone||'-'}</span>
    <span>ğŸ’° ${o.Price||'-'}</span>
    <span>ğŸ“… ${dateFormatted||'-'}</span>
  `;
  div.appendChild(info);

  // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø« (Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª + Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©)
  const actions=document.createElement('div');
  actions.className='actions';

  const actionLabels=['Ø§Ø³ØªÙ„Ø§Ù…','ØªØ¬Ù‡ÙŠØ²','Ø¬Ø§Ù‡Ø²','ØªØ³Ù„ÙŠÙ…'];
  const emojis=['ğŸ“¥','ğŸ”§','âœ…','ğŸšš'];

  emojis.forEach((emoji,i)=>{
    const btn=document.createElement('button');
    btn.className='action-item';
    btn.innerHTML=`${emoji} ${actionLabels[i]}`;
    btn.onclick=()=>updateStatus(o.row,i+1);
    actions.appendChild(btn);
  });

  // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  const editBtn=document.createElement('button');
  editBtn.className='action-item';
  editBtn.innerHTML='âœï¸ ØªØ¹Ø¯ÙŠÙ„';
  editBtn.onclick=()=>openModal(o);
  actions.appendChild(editBtn);

  // Ø²Ø± Ø§Ù„Ø­Ø°Ù
  const delBtn=document.createElement('button');
  delBtn.className='action-item';
  delBtn.style.background='#ff0000';
  delBtn.style.color='#ffffff';
  delBtn.innerHTML='ğŸ—‘ï¸ Ø­Ø°Ù';
  delBtn.onclick=()=>{if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) deleteOrder(o.row);};
  actions.appendChild(delBtn);

  div.appendChild(actions);
  return div;
}


function openModal(o){
  $('#orderModal').style.display='flex';
  $('#editRow').value=o.row;
  $('#newOrderID').value=o.OrderID;
  $('#newCustomer').value=o.CustomerName;
  $('#newPhone').value=o.Phone;
  $('#newPrice').value=o.Price;
  $('#newDate').value=o.Date;
}

$('#addOrderBtn').onclick=()=>{
  $('#orderModal').style.display='flex';
  $('#editRow').value='';
  $('#newOrderID').value=''; $('#newCustomer').value=''; $('#newPhone').value=''; $('#newPrice').value=''; $('#newDate').value='';
};
$('#closeModalBtn').onclick=()=>$('#orderModal').style.display='none';

$('#saveOrderBtn').onclick=async()=>{
  const payload={
    action: $('#editRow').value?'updateOrder':'addOrder',
    row: Number($('#editRow').value)||0,
    OrderID: $('#newOrderID').value,
    CustomerName: $('#newCustomer').value,
    Phone: $('#newPhone').value,
    Price: $('#newPrice').value,
    Date: $('#newDate').value,
    Received:0, Processing:0, Ready:0, Delivered:0
  };
  if(payload.action==='updateOrder'){
    const o=orders.find(x=>x.row===payload.row);
    payload.Received=o.Received;
    payload.Processing=o.Processing;
    payload.Ready=o.Ready;
    payload.Delivered=o.Delivered;
  }
  const res=await fetch(API_BASE,{method:'POST',body:JSON.stringify(payload)}).then(r=>r.json());
  if(res.error){alert(res.message||res.error);} 
  $('#orderModal').style.display='none'; fetchOrders();
};

async function updateStatus(row,status){
  await fetch(API_BASE,{method:'POST',body:JSON.stringify({action:'updateStatus',row,status})});
  fetchOrders();
}
async function deleteOrder(row){
  await fetch(API_BASE,{method:'POST',body:JSON.stringify({action:'deleteOrder',row})});
  fetchOrders();
}

document.querySelectorAll('.filterBtn').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('.filterBtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); render();
});

fetchOrders();
</script>
</body>
</html>
